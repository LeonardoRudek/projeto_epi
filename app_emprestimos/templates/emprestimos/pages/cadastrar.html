{% extends 'base.html' %}
{% block title %}{% if modo == 'editar' %}Editar{% else %}Cadastrar{% endif %} Empréstimo{% endblock %}

{% block content %}
<div class="container my-4">

  <h2 class="h5 mb-3 text-center">
    {% if modo == 'editar' %}Editar{% else %}Cadastrar{% endif %} Empréstimo
  </h2>

  <div class="card shadow-sm p-4">
    <form method="POST"
          action="{% if modo == 'editar' %}{% url 'app_emprestimos:editar' obj.id %}{% else %}{% url 'app_emprestimos:cadastrar' %}{% endif %}">
      {% csrf_token %}

      {# --- Colaborador --- #}
      <div class="mb-3">
        <label for="colaborador" class="form-label">Colaborador</label>
        <select id="colaborador" name="colaborador" class="form-select"
                {% if modo == 'editar' %}disabled{% else %}required{% endif %}>
          <option value="">Selecione...</option>
          {% for c in colaboradores %}
            <option value="{{ c.id }}" {% if modo == 'editar' and obj.colaborador_id == c.id %}selected{% endif %}>
              {{ c.nome }} — {{ c.matricula }}
            </option>
          {% endfor %}
        </select>
      </div>

      {# --- EPI --- #}
      <div class="mb-3">
        <label for="epi" class="form-label">EPI</label>
        <select id="epi" name="epi" class="form-select"
                {% if modo == 'editar' %}disabled{% else %}required{% endif %}>
          <option value="">Selecione...</option>
          {% for e in epis %}
            <option value="{{ e.id }}" {% if modo == 'editar' and obj.epi_id == e.id %}selected{% endif %}>
              {{ e.nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      {# --- Data do Empréstimo (travada no editar) --- #}
      <div class="mb-3">
        <label for="data_emprestimo" class="form-label">Data do Empréstimo</label>
        <input type="datetime-local" step="60" id="data_emprestimo" name="data_emprestimo" class="form-control"
               value="{% if modo == 'editar' and obj.data_emprestimo %}{{ obj.data_emprestimo|date:'Y-m-d\\TH:i' }}{% endif %}"
               {% if modo == 'editar' %}disabled{% endif %}>
      </div>

      {# --- Data prevista (oculta em 'fornecido'; requerida em 'emprestado' no cadastro) --- #}
      <div id="grp-prevista" class="mb-3">
        <label for="data_prevista_devolucao" class="form-label">Data prevista de devolução</label>
        <input type="datetime-local" step="60" id="data_prevista_devolucao" name="data_prevista_devolucao" class="form-control"
               value="{% if modo == 'editar' and obj.data_prevista_devolucao %}{{ obj.data_prevista_devolucao|date:'Y-m-d\\TH:i' }}{% endif %}"
               {% if modo == 'editar' %}disabled{% endif %}>
        <div class="form-text">Para “Emprestado”, precisa ser futura. Para “Fornecido”, não é necessário.</div>
        <div class="invalid-feedback">
          Informe uma data prevista válida e posterior à data de entrega quando o status for “Emprestado”.
        </div>
      </div>

      {# --- Condição na entrega (opcional) --- #}
      <div class="mb-3">
        <label for="condicao_emprestimo" class="form-label">Condição do equipamento (opcional)</label>
        <textarea id="condicao_emprestimo" name="condicao_emprestimo" rows="2"
              class="form-control"
              placeholder="Ex.: Novo, bom estado, arranhões leves na haste..."
              {% if modo == 'editar' %}disabled{% endif %}>{{ obj.condicao_emprestimo }}</textarea>
        <div class="form-text">Campo livre; preencha se quiser registrar a condição na entrega.</div>
      </div>

      {# --- Status (sempre editável) --- #}
      <div class="mb-3">
        <label for="status" class="form-label">Status</label>
        <select id="status" name="status" class="form-select" required>
          {% if modo == 'editar' %}
            {% for value,label in status_choices %}
              <option value="{{ value }}" {% if obj.status == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          {% else %}
            <option value="emprestado">Emprestado</option>
            <option value="fornecido">Fornecido</option>
          {% endif %}
        </select>
      </div>

      {# --- Campos apenas para status finais --- #}
      <div id="box-devolucao" class="mb-3"
           data-finais='["devolvido","danificado","perdido"]'
           style="display:none;">
        <div class="mb-3">
          <label for="data_devolucao" class="form-label">Data da devolução</label>
          <input type="datetime-local" step="60" id="data_devolucao" name="data_devolucao" class="form-control"
                 value="{% if modo == 'editar' and obj.data_devolucao %}{{ obj.data_devolucao|date:'Y-m-d\\TH:i' }}{% endif %}">
          <div class="invalid-feedback">
            Para status final, informe uma data de devolução válida e posterior à data de entrega.
          </div>
        </div>
        <div class="mb-3">
          <label for="observacao_devolucao" class="form-label">Observação na devolução/perda</label>
          <textarea id="observacao_devolucao" name="observacao_devolucao" rows="3" class="form-control"
                    placeholder="Detalhes da devolução, dano ou perda...">{% if modo == 'editar' and obj.observacao_devolucao %}{{ obj.observacao_devolucao }}{% endif %}</textarea>
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'app_emprestimos:listar' %}">Cancelar</a>
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const statusEl      = document.getElementById('status');
  const boxFinais     = document.getElementById('box-devolucao');
  const finais        = boxFinais ? new Set(JSON.parse(boxFinais.dataset.finais)) : new Set();

  const grpPrevista   = document.getElementById('grp-prevista');
  const previstaInput = document.getElementById('data_prevista_devolucao');
  const empInput      = document.getElementById('data_emprestimo');

  const devInput      = document.getElementById('data_devolucao');
  const obsInput      = document.getElementById('observacao_devolucao');

  // acha o <form> pai
  function findForm(el){ while (el && el.tagName !== 'FORM') el = el.parentElement; return el; }
  const formEl = statusEl ? findForm(statusEl) : null;

  // utils de data/hora
  function pad(n){ return String(n).padStart(2,'0'); }
  function toLocalDTValue(d){
    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) +
           'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
  }
  function roundToNext5Min(d){
    const res = new Date(d.getTime());
    const add = (5 - (res.getMinutes()%5)) % 5;
    res.setMinutes(res.getMinutes()+add,0,0);
    return res;
  }
  function parseDT(el){
    if (!el || !el.value) return null;
    const d = new Date(el.value); // local
    return isNaN(d.getTime()) ? null : d;
  }
  function setInvalid(input, invalid){
    if (!input) return;
    input.classList.toggle('is-invalid', !!invalid);
  }

  // Auto-preencher "Data do Empréstimo" no cadastro
  {% if modo != 'editar' %}
  if (empInput && !empInput.value) {
    const now = roundToNext5Min(new Date());
    empInput.value = toLocalDTValue(now);
  }
  {% endif %}

  function setPrevistaMin(){
    if (!previstaInput || !empInput) return;
    const dEmp = parseDT(empInput);
    if (!dEmp) { previstaInput.removeAttribute('min'); return; }
    const min = new Date(dEmp.getTime() + 60*1000); // +1 minuto
    previstaInput.min = toLocalDTValue(min);
    const dPrev = parseDT(previstaInput);
    setInvalid(previstaInput, !!(dPrev && dPrev <= dEmp));
  }

  function toggleUI(){
    if (!statusEl) return;
    const val = statusEl.value;

    // finais: mostra/oculta bloco
    const ehFinal = finais.has(val);
    if (boxFinais) boxFinais.style.display = ehFinal ? 'block' : 'none';
    if (devInput) devInput.disabled = !ehFinal;
    if (obsInput) obsInput.disabled = !ehFinal;
    if (!ehFinal) {
      if (devInput) { devInput.value = ''; setInvalid(devInput,false); }
      if (obsInput) obsInput.value = '';
    }

    // prevista: esconde em fornecido; mostra nos demais
    const ehFornecido  = (val === 'fornecido');
    const ehEmprestado = (val === 'emprestado');
    if (grpPrevista) grpPrevista.style.display = ehFornecido ? 'none' : 'block';

    if (previstaInput) {
      {% if modo != 'editar' %}
      previstaInput.required = ehEmprestado; // só exige no cadastro e se emprestado
      {% endif %}
      if (ehFornecido) {
        previstaInput.value = '';
        setInvalid(previstaInput,false);
      }
    }

    // sincroniza min
    setPrevistaMin();
  }

  function validateClient(){
    let ok = true;
    const val          = statusEl ? statusEl.value : '';
    const ehFinal      = finais.has(val);
    const ehEmprestado = (val === 'emprestado');
    const ehFornecido  = (val === 'fornecido');

    const dEmp  = parseDT(empInput);
    const dPrev = parseDT(previstaInput);
    const dDev  = parseDT(devInput);

    // Emprestado → prevista obrigatória e > data de empréstimo (no cadastro)
    {% if modo != 'editar' %}
      if (ehEmprestado) {
        const invalidaPrev = (!dPrev) || (dPrev && dEmp && dPrev <= dEmp);
        setInvalid(previstaInput, invalidaPrev);
        if (invalidaPrev) ok = false;
      } else {
        setInvalid(previstaInput, false);
      }
    {% endif %}

    // Finais → devolução obrigatória e > data de empréstimo
    if (ehFinal) {
      const invalidaDev = (!dDev) || (dDev && dEmp && dDev < dEmp);
      setInvalid(devInput, invalidaDev);
      if (invalidaDev) ok = false;
    } else {
      setInvalid(devInput, false);
    }

    // Fornecido → nunca acusa erro na prevista
    if (ehFornecido) setInvalid(previstaInput, false);

    return ok;
  }

  // Fallback simples caso o browser não suporte datetime-local
  function ensureDTLocalSupport(input){
    if (!input) return;
    if (input.type !== 'datetime-local') {
      input.setAttribute('placeholder', 'YYYY-MM-DDTHH:mm');
      input.addEventListener('blur', function(){
        const ok = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(this.value || '');
        setInvalid(this, !ok && this.value);
      });
    }
  }
  ensureDTLocalSupport(empInput);
  ensureDTLocalSupport(previstaInput);
  ensureDTLocalSupport(devInput);

  // Eventos
  if (statusEl) {
    toggleUI(); // inicial
    statusEl.addEventListener('change', () => { toggleUI(); validateClient(); });
  }
  if (empInput)      empInput.addEventListener('change', () => { setPrevistaMin(); validateClient(); });
  if (previstaInput) previstaInput.addEventListener('input',  validateClient);
  if (devInput)      devInput.addEventListener('input',       validateClient);

  if (formEl) {
    formEl.addEventListener('submit', function(e){
      if (!validateClient()) { e.preventDefault(); e.stopPropagation(); }
    });
  }
})();
</script>
{% endblock content %}
